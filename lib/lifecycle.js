'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});

var _extends = Object.assign || function (target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i]; for (var key in source) { if (Object.prototype.hasOwnProperty.call(source, key)) { target[key] = source[key]; } } } return target; };

var _utils = require('./utils');

var _utils2 = _interopRequireDefault(_utils);

var _defaultProps = require('./defaultProps');

var _defaultProps2 = _interopRequireDefault(_defaultProps);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

exports.default = {
  getDefaultProps: function getDefaultProps() {
    return _defaultProps2.default;
  },
  getInitialState: function getInitialState() {
    return {
      page: 0,
      pageSize: this.props.defaultPageSize || 10,
      sorting: this.props.defaultSorting,
      expandedRows: {},
      filtering: this.props.defaultFiltering,
      resizing: this.props.defaultResizing,
      currentlyResizing: undefined,
      skipNextSort: false
    };
  },
  getResolvedState: function getResolvedState(props, state) {
    var resolvedState = _extends({}, _utils2.default.compactObject(this.state), _utils2.default.compactObject(this.props), _utils2.default.compactObject(state), _utils2.default.compactObject(props));
    return resolvedState;
  },
  componentWillMount: function componentWillMount() {
    this.setStateWithData(this.getDataModel(this.getResolvedState()));
  },
  componentDidMount: function componentDidMount() {
    this.fireOnChange();
  },
  componentWillReceiveProps: function componentWillReceiveProps(nextProps, nextState) {
    var oldState = this.getResolvedState();
    var newState = this.getResolvedState(nextProps, nextState);

    if (oldState.defaultSorting !== newState.defaultSorting) {
      newState.sorting = newState.defaultSorting;
    }

    if (oldState.showFilters !== newState.showFilters || oldState.showFilters !== newState.showFilters) {
      newState.filtering = newState.defaultFiltering;
    }

    // Props that trigger a data update
    if (oldState.data !== newState.data || oldState.columns !== newState.columns || oldState.pivotBy !== newState.pivotBy || oldState.sorting !== newState.sorting || oldState.showFilters !== newState.showFilters || oldState.filtering !== newState.filtering) {
      this.setStateWithData(this.getDataModel(newState));
    }
  },
  setStateWithData: function setStateWithData(newState, cb) {
    var oldState = this.getResolvedState();
    var newResolvedState = this.getResolvedState({}, newState);
    var freezeWhenExpanded = newResolvedState.freezeWhenExpanded;

    // Default to unfrozen state

    newResolvedState.frozen = false;

    // If freezeWhenExpanded is set, check for frozen conditions
    if (freezeWhenExpanded) {
      // if any rows are expanded, freeze the existing data and sorting
      var keys = Object.keys(newResolvedState.expandedRows);
      for (var i = 0; i < keys.length; i++) {
        if (newResolvedState.expandedRows[keys[i]]) {
          newResolvedState.frozen = true;
          break;
        }
      }
    }

    // If the data isn't frozen and either the data or
    // sorting model has changed, update the data
    if (oldState.frozen && !newResolvedState.frozen || oldState.sorting !== newResolvedState.sorting || oldState.filtering !== newResolvedState.filtering || oldState.showFilters !== newResolvedState.showFilters || !newResolvedState.frozen && oldState.resolvedData !== newResolvedState.resolvedData) {
      // Handle collapseOnSortingChange & collapseOnDataChange
      if (oldState.sorting !== newResolvedState.sorting && this.props.collapseOnSortingChange || oldState.filtering !== newResolvedState.filtering || oldState.showFilters !== newResolvedState.showFilters || !newResolvedState.frozen && oldState.resolvedData !== newResolvedState.resolvedData && this.props.collapseOnDataChange) {
        newResolvedState.expandedRows = {};
      }

      Object.assign(newResolvedState, this.getSortedData(newResolvedState));
    }

    // Calculate pageSize all the time
    if (newResolvedState.sortedData) {
      newResolvedState.pages = newResolvedState.manual ? newResolvedState.pages : Math.ceil(newResolvedState.sortedData.length / newResolvedState.pageSize);
      newResolvedState.page = Math.max(newResolvedState.page >= newResolvedState.pages ? newResolvedState.pages - 1 : newResolvedState.page, 0);
    }

    return this.setState(newResolvedState, cb);
  }
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9saWZlY3ljbGUuanMiXSwibmFtZXMiOlsiZ2V0RGVmYXVsdFByb3BzIiwiZ2V0SW5pdGlhbFN0YXRlIiwicGFnZSIsInBhZ2VTaXplIiwicHJvcHMiLCJkZWZhdWx0UGFnZVNpemUiLCJzb3J0aW5nIiwiZGVmYXVsdFNvcnRpbmciLCJleHBhbmRlZFJvd3MiLCJmaWx0ZXJpbmciLCJkZWZhdWx0RmlsdGVyaW5nIiwicmVzaXppbmciLCJkZWZhdWx0UmVzaXppbmciLCJjdXJyZW50bHlSZXNpemluZyIsInVuZGVmaW5lZCIsInNraXBOZXh0U29ydCIsImdldFJlc29sdmVkU3RhdGUiLCJzdGF0ZSIsInJlc29sdmVkU3RhdGUiLCJjb21wYWN0T2JqZWN0IiwiY29tcG9uZW50V2lsbE1vdW50Iiwic2V0U3RhdGVXaXRoRGF0YSIsImdldERhdGFNb2RlbCIsImNvbXBvbmVudERpZE1vdW50IiwiZmlyZU9uQ2hhbmdlIiwiY29tcG9uZW50V2lsbFJlY2VpdmVQcm9wcyIsIm5leHRQcm9wcyIsIm5leHRTdGF0ZSIsIm9sZFN0YXRlIiwibmV3U3RhdGUiLCJzaG93RmlsdGVycyIsImRhdGEiLCJjb2x1bW5zIiwicGl2b3RCeSIsImNiIiwibmV3UmVzb2x2ZWRTdGF0ZSIsImZyZWV6ZVdoZW5FeHBhbmRlZCIsImZyb3plbiIsImtleXMiLCJPYmplY3QiLCJpIiwibGVuZ3RoIiwicmVzb2x2ZWREYXRhIiwiY29sbGFwc2VPblNvcnRpbmdDaGFuZ2UiLCJjb2xsYXBzZU9uRGF0YUNoYW5nZSIsImFzc2lnbiIsImdldFNvcnRlZERhdGEiLCJzb3J0ZWREYXRhIiwicGFnZXMiLCJtYW51YWwiLCJNYXRoIiwiY2VpbCIsIm1heCIsInNldFN0YXRlIl0sIm1hcHBpbmdzIjoiOzs7Ozs7OztBQUFBOzs7O0FBQ0E7Ozs7OztrQkFFZTtBQUNiQSxpQkFEYSw2QkFDTTtBQUNqQjtBQUNELEdBSFk7QUFLYkMsaUJBTGEsNkJBS007QUFDakIsV0FBTztBQUNMQyxZQUFN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aUJBQWlCYSxLQUFqQixHQUF5QixDQUEzRSxHQUErRWIsaUJBQWlCakMsSUFBekcsRUFBK0csQ0FBL0csQ0FBeEI7QUFDRDs7QUFFRCxXQUFPLEtBQUttRCxRQUFMLENBQWNsQixnQkFBZCxFQUFnQ0QsRUFBaEMsQ0FBUDtBQUNEO0FBL0dZLEMiLCJmaWxlIjoibGlmZWN5Y2xlLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IF8gZnJvbSAnLi91dGlscydcclxuaW1wb3J0IGRlZmF1bHRQcm9wcyBmcm9tICcuL2RlZmF1bHRQcm9wcydcclxuXHJcbmV4cG9ydCBkZWZhdWx0IHtcclxuICBnZXREZWZhdWx0UHJvcHMgKCkge1xyXG4gICAgcmV0dXJuIGRlZmF1bHRQcm9wc1xyXG4gIH0sXHJcblxyXG4gIGdldEluaXRpYWxTdGF0ZSAoKSB7XHJcbiAgICByZXR1cm4ge1xyXG4gICAgICBwYWdlOiAwLFxyXG4gICAgICBwYWdlU2l6ZTogdGhpcy5wcm9wcy5kZWZhdWx0UGFnZVNpemUgfHwgMTAsXHJcbiAgICAgIHNvcnRpbmc6IHRoaXMucHJvcHMuZGVmYXVsdFNvcnRpbmcsXHJcbiAgICAgIGV4cGFuZGVkUm93czoge30sXHJcbiAgICAgIGZpbHRlcmluZzogdGhpcy5wcm9wcy5kZWZhdWx0RmlsdGVyaW5nLFxyXG4gICAgICByZXNpemluZzogdGhpcy5wcm9wcy5kZWZhdWx0UmVzaXppbmcsXHJcbiAgICAgIGN1cnJlbnRseVJlc2l6aW5nOiB1bmRlZmluZWQsXHJcbiAgICAgIHNraXBOZXh0U29ydDogZmFsc2VcclxuICAgIH1cclxuICB9LFxyXG5cclxuICBnZXRSZXNvbHZlZFN0YXRlIChwcm9wcywgc3RhdGUpIHtcclxuICAgIGNvbnN0IHJlc29sdmVkU3RhdGUgPSB7XHJcbiAgICAgIC4uLl8uY29tcGFjdE9iamVjdCh0aGlzLnN0YXRlKSxcclxuICAgICAgLi4uXy5jb21wYWN0T2JqZWN0KHRoaXMucHJvcHMpLFxyXG4gICAgICAuLi5fLmNvbXBhY3RPYmplY3Qoc3RhdGUpLFxyXG4gICAgICAuLi5fLmNvbXBhY3RPYmplY3QocHJvcHMpXHJcbiAgICB9XHJcbiAgICByZXR1cm4gcmVzb2x2ZWRTdGF0ZVxyXG4gIH0sXHJcblxyXG4gIGNvbXBvbmVudFdpbGxNb3VudCAoKSB7XHJcbiAgICB0aGlzLnNldFN0YXRlV2l0aERhdGEodGhpcy5nZXREYXRhTW9kZWwodGhpcy5nZXRSZXNvbHZlZFN0YXRlKCkpKVxyXG4gIH0sXHJcblxyXG4gIGNvbXBvbmVudERpZE1vdW50ICgpIHtcclxuICAgIHRoaXMuZmlyZU9uQ2hhbmdlKClcclxuICB9LFxyXG5cclxuICBjb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzIChuZXh0UHJvcHMsIG5leHRTdGF0ZSkge1xyXG4gICAgY29uc3Qgb2xkU3RhdGUgPSB0aGlzLmdldFJlc29sdmVkU3RhdGUoKVxyXG4gICAgY29uc3QgbmV3U3RhdGUgPSB0aGlzLmdldFJlc29sdmVkU3RhdGUobmV4dFByb3BzLCBuZXh0U3RhdGUpXHJcblxyXG4gICAgaWYgKG9sZFN0YXRlLmRlZmF1bHRTb3J0aW5nICE9PSBuZXdTdGF0ZS5kZWZhdWx0U29ydGluZykge1xyXG4gICAgICBuZXdTdGF0ZS5zb3J0aW5nID0gbmV3U3RhdGUuZGVmYXVsdFNvcnRpbmdcclxuICAgIH1cclxuXHJcbiAgICBpZiAoKG9sZFN0YXRlLnNob3dGaWx0ZXJzICE9PSBuZXdTdGF0ZS5zaG93RmlsdGVycykgfHxcclxuICAgICAgKG9sZFN0YXRlLnNob3dGaWx0ZXJzICE9PSBuZXdTdGF0ZS5zaG93RmlsdGVycykpIHtcclxuICAgICAgbmV3U3RhdGUuZmlsdGVyaW5nID0gbmV3U3RhdGUuZGVmYXVsdEZpbHRlcmluZ1xyXG4gICAgfVxyXG5cclxuICAgIC8vIFByb3BzIHRoYXQgdHJpZ2dlciBhIGRhdGEgdXBkYXRlXHJcbiAgICBpZiAoXHJcbiAgICAgIG9sZFN0YXRlLmRhdGEgIT09IG5ld1N0YXRlLmRhdGEgfHxcclxuICAgICAgb2xkU3RhdGUuY29sdW1ucyAhPT0gbmV3U3RhdGUuY29sdW1ucyB8fFxyXG4gICAgICBvbGRTdGF0ZS5waXZvdEJ5ICE9PSBuZXdTdGF0ZS5waXZvdEJ5IHx8XHJcbiAgICAgIG9sZFN0YXRlLnNvcnRpbmcgIT09IG5ld1N0YXRlLnNvcnRpbmcgfHxcclxuICAgICAgb2xkU3RhdGUuc2hvd0ZpbHRlcnMgIT09IG5ld1N0YXRlLnNob3dGaWx0ZXJzIHx8XHJcbiAgICAgIG9sZFN0YXRlLmZpbHRlcmluZyAhPT0gbmV3U3RhdGUuZmlsdGVyaW5nXHJcbiAgICApIHtcclxuICAgICAgdGhpcy5zZXRTdGF0ZVdpdGhEYXRhKHRoaXMuZ2V0RGF0YU1vZGVsKG5ld1N0YXRlKSlcclxuICAgIH1cclxuICB9LFxyXG5cclxuICBzZXRTdGF0ZVdpdGhEYXRhIChuZXdTdGF0ZSwgY2IpIHtcclxuICAgIGNvbnN0IG9sZFN0YXRlID0gdGhpcy5nZXRSZXNvbHZlZFN0YXRlKClcclxuICAgIGNvbnN0IG5ld1Jlc29sdmVkU3RhdGUgPSB0aGlzLmdldFJlc29sdmVkU3RhdGUoe30sIG5ld1N0YXRlKVxyXG4gICAgY29uc3Qge2ZyZWV6ZVdoZW5FeHBhbmRlZH0gPSBuZXdSZXNvbHZlZFN0YXRlXHJcblxyXG4gICAgLy8gRGVmYXVsdCB0byB1bmZyb3plbiBzdGF0ZVxyXG4gICAgbmV3UmVzb2x2ZWRTdGF0ZS5mcm96ZW4gPSBmYWxzZVxyXG5cclxuICAgIC8vIElmIGZyZWV6ZVdoZW5FeHBhbmRlZCBpcyBzZXQsIGNoZWNrIGZvciBmcm96ZW4gY29uZGl0aW9uc1xyXG4gICAgaWYgKGZyZWV6ZVdoZW5FeHBhbmRlZCkge1xyXG4gICAgICAvLyBpZiBhbnkgcm93cyBhcmUgZXhwYW5kZWQsIGZyZWV6ZSB0aGUgZXhpc3RpbmcgZGF0YSBhbmQgc29ydGluZ1xyXG4gICAgICBjb25zdCBrZXlzID0gT2JqZWN0LmtleXMobmV3UmVzb2x2ZWRTdGF0ZS5leHBhbmRlZFJvd3MpXHJcbiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwga2V5cy5sZW5ndGg7IGkrKykge1xyXG4gICAgICAgIGlmIChuZXdSZXNvbHZlZFN0YXRlLmV4cGFuZGVkUm93c1trZXlzW2ldXSkge1xyXG4gICAgICAgICAgbmV3UmVzb2x2ZWRTdGF0ZS5mcm96ZW4gPSB0cnVlXHJcbiAgICAgICAgICBicmVha1xyXG4gICAgICAgIH1cclxuICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIC8vIElmIHRoZSBkYXRhIGlzbid0IGZyb3plbiBhbmQgZWl0aGVyIHRoZSBkYXRhIG9yXHJcbiAgICAvLyBzb3J0aW5nIG1vZGVsIGhhcyBjaGFuZ2VkLCB1cGRhdGUgdGhlIGRhdGFcclxuICAgIGlmIChcclxuICAgICAgKG9sZFN0YXRlLmZyb3plbiAmJiAhbmV3UmVzb2x2ZWRTdGF0ZS5mcm96ZW4pIHx8XHJcbiAgICAgIG9sZFN0YXRlLnNvcnRpbmcgIT09IG5ld1Jlc29sdmVkU3RhdGUuc29ydGluZyB8fFxyXG4gICAgICBvbGRTdGF0ZS5maWx0ZXJpbmcgIT09IG5ld1Jlc29sdmVkU3RhdGUuZmlsdGVyaW5nIHx8XHJcbiAgICAgIG9sZFN0YXRlLnNob3dGaWx0ZXJzICE9PSBuZXdSZXNvbHZlZFN0YXRlLnNob3dGaWx0ZXJzIHx8XHJcbiAgICAgICghbmV3UmVzb2x2ZWRTdGF0ZS5mcm96ZW4gJiYgb2xkU3RhdGUucmVzb2x2ZWREYXRhICE9PSBuZXdSZXNvbHZlZFN0YXRlLnJlc29sdmVkRGF0YSlcclxuICAgICkge1xyXG4gICAgICAvLyBIYW5kbGUgY29sbGFwc2VPblNvcnRpbmdDaGFuZ2UgJiBjb2xsYXBzZU9uRGF0YUNoYW5nZVxyXG4gICAgICBpZiAoXHJcbiAgICAgICAgKG9sZFN0YXRlLnNvcnRpbmcgIT09IG5ld1Jlc29sdmVkU3RhdGUuc29ydGluZyAmJiB0aGlzLnByb3BzLmNvbGxhcHNlT25Tb3J0aW5nQ2hhbmdlKSB8fFxyXG4gICAgICAgIChvbGRTdGF0ZS5maWx0ZXJpbmcgIT09IG5ld1Jlc29sdmVkU3RhdGUuZmlsdGVyaW5nKSB8fFxyXG4gICAgICAgIChvbGRTdGF0ZS5zaG93RmlsdGVycyAhPT0gbmV3UmVzb2x2ZWRTdGF0ZS5zaG93RmlsdGVycykgfHxcclxuICAgICAgICAoIW5ld1Jlc29sdmVkU3RhdGUuZnJvemVuICYmIG9sZFN0YXRlLnJlc29sdmVkRGF0YSAhPT0gbmV3UmVzb2x2ZWRTdGF0ZS5yZXNvbHZlZERhdGEgJiYgdGhpcy5wcm9wcy5jb2xsYXBzZU9uRGF0YUNoYW5nZSlcclxuICAgICAgKSB7XHJcbiAgICAgICAgbmV3UmVzb2x2ZWRTdGF0ZS5leHBhbmRlZFJvd3MgPSB7fVxyXG4gICAgICB9XHJcblxyXG4gICAgICBPYmplY3QuYXNzaWduKG5ld1Jlc29sdmVkU3RhdGUsIHRoaXMuZ2V0U29ydGVkRGF0YShuZXdSZXNvbHZlZFN0YXRlKSlcclxuICAgIH1cclxuXHJcbiAgICAvLyBDYWxjdWxhdGUgcGFnZVNpemUgYWxsIHRoZSB0aW1lXHJcbiAgICBpZiAobmV3UmVzb2x2ZWRTdGF0ZS5zb3J0ZWREYXRhKSB7XHJcbiAgICAgIG5ld1Jlc29sdmVkU3RhdGUucGFnZXMgPSBuZXdSZXNvbHZlZFN0YXRlLm1hbnVhbCA/IG5ld1Jlc29sdmVkU3RhdGUucGFnZXMgOiBNYXRoLmNlaWwobmV3UmVzb2x2ZWRTdGF0ZS5zb3J0ZWREYXRhLmxlbmd0aCAvIG5ld1Jlc29sdmVkU3RhdGUucGFnZVNpemUpXHJcbiAgICAgIG5ld1Jlc29sdmVkU3RhdGUucGFnZSA9IE1hdGgubWF4KG5ld1Jlc29sdmVkU3RhdGUucGFnZSA+PSBuZXdSZXNvbHZlZFN0YXRlLnBhZ2VzID8gbmV3UmVzb2x2ZWRTdGF0ZS5wYWdlcyAtIDEgOiBuZXdSZXNvbHZlZFN0YXRlLnBhZ2UsIDApXHJcbiAgICB9XHJcblxyXG4gICAgcmV0dXJuIHRoaXMuc2V0U3RhdGUobmV3UmVzb2x2ZWRTdGF0ZSwgY2IpXHJcbiAgfVxyXG59XHJcbiJdfQ==